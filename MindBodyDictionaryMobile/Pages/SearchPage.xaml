<?xml version="1.0" encoding="UTF-8"?>
<ContentPage
    xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
    xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
    xmlns:pm="clr-namespace:MindBodyDictionaryMobile.PageModels"
    xmlns:models="clr-namespace:MindBodyDictionaryMobile.Models"
    xmlns:controls="clr-namespace:MindBodyDictionaryMobile.Pages.Controls"
    x:DataType="pm:SearchPageModel"
    x:Class="MindBodyDictionaryMobile.Pages.SearchPage"
    Title="Search">

    <Grid RowDefinitions="Auto,*,Auto">
        <!-- Search Bar -->
        <Frame Grid.Row="0" Padding="10" Margin="0" CornerRadius="0" HasShadow="False"
            BorderColor="{AppThemeBinding Light={StaticResource Gray200}, Dark={StaticResource Gray700}}">
            <VerticalStackLayout>
                <SearchBar
                    Placeholder="Search conditions..."
                    Text="{Binding SearchQuery}"
                    SearchButtonPressed="OnSearchButtonPressed"/>
            </VerticalStackLayout>
        </Frame>

        <!-- Results -->
        <CollectionView
            Grid.Row="1"
            ItemsSource="{Binding FilteredConditions}"
            SelectionMode="Single"
            SelectionChangedCommand="{Binding SelectConditionCommand}"
            SelectionChangedCommandParameter="{Binding SelectedItem, Source={RelativeSource Self}}">

            <CollectionView.ItemTemplate>
                <DataTemplate x:DataType="models:MbdCondition">
                    <Border Style="{StaticResource SearchConditionCard}">
                        <Border.GestureRecognizers>
                            <TapGestureRecognizer Command="{Binding Source={RelativeSource AncestorType={x:Type pm:SearchPageModel}}, Path=SelectConditionCommand}"
                                                    CommandParameter="{Binding .}" />
                        </Border.GestureRecognizers>

                        <Grid RowDefinitions="*,Auto">
                            <!-- Lock overlay -->
                            <Image Grid.Row="0"
                                  Style="{StaticResource SearchConditionImage}"
                                  Opacity="1"
                                  Source="locked_icon.png"
                                  ZIndex="1"
                                  IsVisible="{Binding DisplayLock}" />

                            <!-- Condition image -->
                            <Image Grid.Row="0"
                                  Style="{StaticResource SearchConditionImage}"
                                  Source="{Binding CachedImageOneSource}" />

                            <!-- Condition name -->
                            <Label Grid.Row="1"
                                  Style="{StaticResource SearchConditionLabel}"
                                  Text="{Binding Name}" />
                        </Grid>
                    </Border>
                </DataTemplate>
            </CollectionView.ItemTemplate>

            <CollectionView.EmptyViewTemplate>
                <DataTemplate>
                    <VerticalStackLayout
                        Padding="20"
                        VerticalOptions="Center"
                        HorizontalOptions="Center"
                        Spacing="10">

                        <Label
                            Text="No conditions found"
                            FontSize="16"
                            TextColor="{AppThemeBinding Light={StaticResource Gray600}, Dark={StaticResource Gray300}}"
                            HorizontalTextAlignment="Center"/>

                        <Label
                            Text="Try searching with different keywords"
                            FontSize="12"
                            TextColor="{AppThemeBinding Light={StaticResource Gray500}, Dark={StaticResource Gray400}}"
                            HorizontalTextAlignment="Center"/>
                    </VerticalStackLayout>
                </DataTemplate>
            </CollectionView.EmptyViewTemplate>
        </CollectionView>

        <controls:AddButton
            Grid.Row="2"
            Command="{Binding AddConditionCommand}"
            SemanticProperties.Description="Add condition" />
    </Grid>
</ContentPage>
