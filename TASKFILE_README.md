# Push Notifications Setup with Taskfile

This project uses [Task](https://taskfile.dev) to automate Firebase and infrastructure setup.

## Prerequisites

Install required tools:

```bash
# Install Task (if not already installed)
brew install go-task

# Install Firebase CLI
npm install -g firebase-tools

# Install Google Cloud CLI (optional, for FCM setup)
brew install google-cloud-sdk
```

## Quick Start

### 1. Complete Setup (Automated)

Run the complete automated setup:

```bash
task setup-complete
```

This will:
- ✅ Check prerequisites
- ✅ Create Firebase project
- ✅ Add Android app to Firebase
- ✅ Download `google-services.json`
- ✅ Enable Firebase Cloud Messaging
- ✅ Generate secure API key
- ✅ Create `terraform.tfvars` template
- ℹ️ Show Apple Developer Portal instructions

### 2. Manual Steps

After running `task setup-complete`, you need to:

1. **Get FCM Server Key**: Follow the displayed instructions or run:
   ```bash
   task firebase-get-server-key
   ```

2. **Setup Apple Developer Portal**: Follow the displayed instructions or run:
   ```bash
   task apple-info
   ```

3. **Edit Configuration**: Update `tofu/terraform.tfvars` with all credentials

4. **Deploy Infrastructure**:
   ```bash
   task tofu-apply
   ```

5. **Update App Config**:
   ```bash
   task update-notification-config
   ```

6. **Build App**:
   ```bash
   task build
   ```

## Available Tasks

View all available tasks:

```bash
task --list
```

### Firebase Tasks

| Task | Description |
|------|-------------|
| `task firebase-login` | Login to Firebase |
| `task firebase-create-project` | Create Firebase project |
| `task firebase-add-android` | Add Android app to Firebase |
| `task firebase-download-config` | Download google-services.json |
| `task firebase-enable-fcm` | Enable FCM API |
| `task firebase-get-server-key` | Get FCM server key instructions |
| `task firebase-setup` | Complete Firebase setup |

### Apple Tasks

| Task | Description |
|------|-------------|
| `task apple-info` | Display Apple setup instructions |

### Infrastructure Tasks

| Task | Description |
|------|-------------|
| `task generate-api-key` | Generate secure API key |
| `task create-tfvars` | Create terraform.tfvars from template |
| `task tofu-init` | Initialize OpenTofu |
| `task tofu-plan` | Plan infrastructure changes |
| `task tofu-apply` | Deploy infrastructure |
| `task tofu-output` | Show infrastructure outputs |
| `task tofu-destroy` | Destroy infrastructure |

### Build Tasks

| Task | Description |
|------|-------------|
| `task build` | Build all platforms |
| `task build-android` | Build Android only |
| `task build-ios` | Build iOS only |
| `task clean` | Clean build artifacts |

### Testing Tasks

| Task | Description |
|------|-------------|
| `task test-notification` | Open Azure Portal to test notifications |
| `task update-notification-config` | Update app config with API endpoint |

## Configuration

### Environment Variables

Copy `.env.example` to `.env` and customize:

```bash
cp .env.example .env
```

Edit `.env`:
```bash
FIREBASE_PROJECT_ID=mindbody-dictionary
APPLE_TEAM_ID=YOUR_TEAM_ID_HERE
```

## Step-by-Step Workflow

### Initial Setup

1. **Check prerequisites**:
   ```bash
   task check-prereqs
   ```

2. **Setup Firebase**:
   ```bash
   task firebase-setup
   ```

3. **Get Apple info**:
   ```bash
   task apple-info
   ```

4. **Generate API key**:
   ```bash
   task generate-api-key
   ```

5. **Create tfvars**:
   ```bash
   task create-tfvars
   ```

6. **Edit `tofu/terraform.tfvars`** with all your credentials

### Deploy Infrastructure

1. **Initialize**:
   ```bash
   task tofu-init
   ```

2. **Plan**:
   ```bash
   task tofu-plan
   ```

3. **Apply**:
   ```bash
   task tofu-apply
   ```

4. **Get outputs**:
   ```bash
   task tofu-output
   ```

### Update App

1. **Update config**:
   ```bash
   task update-notification-config
   ```

2. **Build**:
   ```bash
   task build
   ```

### Testing

1. **Test notification**:
   ```bash
   task test-notification
   ```

## Troubleshooting

### Firebase CLI not authenticated

Run:
```bash
task firebase-login
```

### OpenTofu not initialized

Run:
```bash
task tofu-init
```

### Missing terraform.tfvars

Run:
```bash
task create-tfvars
```

Then edit the file with your credentials.

### google-services.json not found

Run:
```bash
task firebase-download-config
```

## What Gets Automated

✅ **Fully Automated**:
- Firebase project creation
- Android app registration in Firebase
- google-services.json download
- FCM API enablement
- API key generation
- terraform.tfvars template creation
- Infrastructure deployment
- Config file updates

⚠️ **Partially Automated** (manual steps required):
- FCM server key retrieval (browser required)
- Apple Developer Portal setup (no CLI available)

## Security Notes

- `.env` is git-ignored
- `tofu/terraform.tfvars` is git-ignored
- Never commit credentials to version control
- Use strong API keys (generated by task)
- Rotate keys regularly

## Further Documentation

- See `tofu/SETUP_TASKS.md` for detailed manual setup instructions
- See `PUSH_NOTIFICATIONS_IMPLEMENTATION.md` for implementation details
- See `tofu/README.md` for infrastructure documentation

## Example Complete Workflow

```bash
# One-time setup
task setup-complete

# Complete manual steps (Apple, FCM key)
# Edit tofu/terraform.tfvars

# Deploy
task tofu-apply
task update-notification-config

# Build and test
task build
task test-notification
```

## CI/CD Integration

These tasks can be integrated into CI/CD pipelines:

```yaml
# Example GitHub Actions
- name: Setup Firebase
  run: task firebase-setup
  
- name: Deploy Infrastructure  
  run: task tofu-apply
  
- name: Build App
  run: task build
```

## Support

For issues or questions:
- Check `task --list` for available commands
- See detailed docs in `tofu/SETUP_TASKS.md`
- Review Firebase/Apple/Azure documentation
