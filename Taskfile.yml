version: '3'

vars:
  PROJECT_NAME: mindbody-dictionary
  ANDROID_PACKAGE: com.mindbodydictionary.mindbodydictionarymobile
  IOS_BUNDLE_ID: com.mindbodydictionary.mindbodydictionarymobile
  FIREBASE_PROJECT_ID: '{{.FIREBASE_PROJECT_ID | default "mindbody-dictionary"}}'
  APPLE_TEAM_ID: '{{.APPLE_TEAM_ID}}'
  APNS_KEY_NAME: MindBodyDictionaryAPNsKey
  XCODE_VERSION: '26.0.1'
  XCODE_XIP_URL: 'REPLACE_WITH_ACTUAL_URL_FROM_DEVELOPER_APPLE_COM'
  XCODE_XIP_FILENAME: 'Xcode_{{.XCODE_VERSION}}_Apple_silicon.xip'

dotenv: [ '.env' ]

tasks:
  default:
    desc: Show available tasks
    cmds:
    - task --list

  check-prereqs:
    desc: Check if required CLIs are installed
    cmds:
    - |
      echo "Checking prerequisites..."
      command -v firebase >/dev/null 2>&1 || { echo "âŒ Firebase CLI not installed. Run: npm install -g firebase-tools"; exit 1; }
      echo "âœ… Firebase CLI found"
      command -v gcloud >/dev/null 2>&1 || { echo "âš ï¸  Google Cloud CLI not found (optional but recommended)"; }
      echo "Note: Apple Developer tasks require manual portal access (no official CLI)"
      echo "âœ… Prerequisites check complete"

  firebase-login:
    desc: Login to Firebase
    cmds:
    - firebase login
    status:
    - firebase projects:list >/dev/null 2>&1

  firebase-create-project:
    desc: Create Firebase project
    deps: [ firebase-login ]
    cmds:
    - |
      echo "Creating Firebase project: {{.FIREBASE_PROJECT_ID}}"
      firebase projects:create {{.FIREBASE_PROJECT_ID}} --display-name "{{.PROJECT_NAME}}"
    status:
    - firebase projects:list | grep -q {{.FIREBASE_PROJECT_ID}}

  firebase-add-android:
    desc: Add Android app to Firebase project
    deps: [ firebase-create-project ]
    cmds:
    - |
      echo "Adding Android app to Firebase project..."
      firebase apps:create ANDROID \
        --project={{.FIREBASE_PROJECT_ID}} \
        --package-name={{.ANDROID_PACKAGE}}
    status:
    - firebase apps:list ANDROID --project={{.FIREBASE_PROJECT_ID}} 2>&1 | grep -q "ANDROID"
    preconditions:
    - sh: firebase projects:list | grep -q {{.FIREBASE_PROJECT_ID}}
      msg: "Firebase project {{.FIREBASE_PROJECT_ID}} does not exist. Run 'task firebase-create-project' first."

  firebase-download-config:
    desc: Download google-services.json
    deps: [ firebase-add-android ]
    cmds:
    - |
      echo "Downloading google-services.json..."
      firebase apps:sdkconfig ANDROID \
        --project={{.FIREBASE_PROJECT_ID}} \
        --out=MindBodyDictionaryMobile/Platforms/Android/google-services.json 
      echo "âœ… google-services.json downloaded to MindBodyDictionaryMobile/Platforms/Android/"

  firebase-enable-fcm:
    desc: Enable Firebase Cloud Messaging (requires gcloud)
    deps: [ firebase-create-project ]
    cmds:
    - |
      echo "Enabling Firebase Cloud Messaging API..."
      gcloud services enable fcm.googleapis.com --project={{.FIREBASE_PROJECT_ID}}
      echo "âœ… FCM enabled"
    preconditions:
    - sh: command -v gcloud >/dev/null 2>&1
      msg: "Google Cloud CLI not found. Install from: https://cloud.google.com/sdk/docs/install"

  firebase-get-server-key:
    desc: Get FCM credentials (requires manual steps)
    cmds:
    - |
      echo "ğŸ“‹ To get your FCM credentials:"
      echo "1. Go to: https://console.firebase.google.com/project/{{.FIREBASE_PROJECT_ID}}/settings/cloudmessaging"
      echo "2. Under 'Firebase Cloud Messaging API (V1)' - verify it shows 'Enabled'"
      echo "3. Note your Sender ID (e.g., 533561443811)"
      echo "4. Click 'Manage Service Accounts' to open Google Cloud Console"
      echo "5. Create/download a service account key (JSON format)"
      echo "6. Add to tofu/terraform.tfvars:"
      echo "   - fcm_sender_id = \"YOUR_SENDER_ID\""
      echo "   - fcm_service_account_key = content of service account JSON file"
      echo ""
      echo "Note: The legacy Server Key API was deprecated 6/20/2023 and removed 6/20/2024."
      echo "Firebase now uses the V1 API with service account authentication."
      echo ""
      echo "Opening Firebase Console..."
      open "https://console.firebase.google.com/project/{{.FIREBASE_PROJECT_ID}}/settings/cloudmessaging" || true

  firebase-setup:
    desc: Complete Firebase setup (create project, add Android app, download config)
    cmds:
    - task: check-prereqs
    - task: firebase-create-project
    - task: firebase-add-android
    - task: firebase-download-config
    - task: firebase-get-server-key

  apple-info:
    desc: Display Apple Developer setup instructions
    cmds:
    - |
      echo "ğŸ Apple Push Notification Setup"
      echo "=================================="
      echo ""
      echo "Apple does not provide a CLI for Developer Portal management."
      echo "You must complete these steps manually:"
      echo ""
      echo "1. CREATE APP IDENTIFIER"
      echo "   â€¢ Go to: https://developer.apple.com/account/resources/identifiers/list"
      echo "   â€¢ Click '+' to create new identifier"
      echo "   â€¢ Select 'App IDs' â†’ Continue"
      echo "   â€¢ Select 'App' â†’ Continue"
      echo "   â€¢ Description: MindBody Dictionary Mobile"
      echo "   â€¢ Bundle ID: {{.IOS_BUNDLE_ID}}"
      echo "   â€¢ Enable 'Push Notifications' capability"
      echo "   â€¢ Click Continue â†’ Register"
      echo ""
      echo "2. CREATE APNs AUTHENTICATION KEY"
      echo "   â€¢ Go to: https://developer.apple.com/account/resources/authkeys/list"
      echo "   â€¢ Click '+' to create new key"
      echo "   â€¢ Key Name: {{.APNS_KEY_NAME}}"
      echo "   â€¢ Enable 'Apple Push Notifications service (APNs)'"
      echo "   â€¢ Click Continue â†’ Register"
      echo "   â€¢ Download the .p8 file (you can only download once!)"
      echo "   â€¢ Note the Key ID (10 characters)"
      echo "   â€¢ Note your Team ID (top-right corner of portal)"
      echo ""
      echo "3. SAVE CREDENTIALS"
      echo "   â€¢ Move .p8 file to a secure location"
      echo "   â€¢ Update tofu/terraform.tfvars:"
      echo "     - apns_bundle_id = \"{{.IOS_BUNDLE_ID}}\""
      echo "     - apns_key_id = \"YOUR_KEY_ID\""
      echo "     - apns_team_id = \"YOUR_TEAM_ID\""
      echo "     - apns_token = content of .p8 file (including BEGIN/END lines)"
      echo ""
      echo "Opening Apple Developer Portal..."
      open "https://developer.apple.com/account/resources/identifiers/list" || true

  generate-api-key:
    desc: Generate secure API key for terraform.tfvars
    cmds:
    - |
      echo "Generating secure API key..."
      API_KEY=$(openssl rand -base64 32)
      echo ""
      echo "âœ… Generated API Key:"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "$API_KEY"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo ""
      echo "Add this to tofu/terraform.tfvars:"
      echo "api_key = \"$API_KEY\""
      echo ""
      echo "And to MindBodyDictionaryMobile/NotificationConfig.cs:"
      echo "public const string ApiKey = \"$API_KEY\";"

  create-tfvars:
    desc: Create terraform.tfvars from example
    dir: tofu
    cmds:
    - |
      if [ -f terraform.tfvars ]; then
        echo "âš ï¸  terraform.tfvars already exists"
        read -p "Overwrite? (y/N): " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
          echo "Cancelled"
          exit 0
        fi
      fi
      cp terraform.tfvars.example terraform.tfvars
      echo "âœ… Created tofu/terraform.tfvars from example"
      echo "âš ï¸  Please edit this file and fill in all values"
      echo ""
      echo "Run these tasks to help:"
      echo "  task generate-api-key    # Generate API key"
      echo "  task firebase-setup      # Setup Firebase"
      echo "  task apple-info          # Apple setup instructions"

  tofu-init:
    desc: Initialize OpenTofu
    dir: tofu
    cmds:
    - tofu init
    sources:
    - "*.tf"
    status:
    - test -d .terraform

  tofu-plan:
    desc: Plan OpenTofu deployment
    dir: tofu
    deps: [ tofu-init ]
    cmds:
    - tofu plan
    preconditions:
    - sh: test -f terraform.tfvars
      msg: "terraform.tfvars not found. Run 'task create-tfvars' first."

  tofu-apply:
    desc: Apply OpenTofu deployment
    dir: tofu
    deps: [ tofu-init ]
    cmds:
    - tofu apply
    preconditions:
    - sh: test -f terraform.tfvars
      msg: "terraform.tfvars not found. Run 'task create-tfvars' first."

  tofu-destroy:
    desc: Destroy OpenTofu infrastructure
    dir: tofu
    cmds:
    - tofu destroy
    preconditions:
    - sh: test -f terraform.tfvars
      msg: "terraform.tfvars not found."

  tofu-output:
    desc: Show OpenTofu outputs
    dir: tofu
    cmds:
    - tofu output

  update-notification-config:
    desc: Update NotificationConfig.cs with Tofu outputs
    dir: tofu
    cmds:
    - |
      echo "Extracting Tofu outputs..."
      API_ENDPOINT=$(tofu output -raw api_endpoint 2>/dev/null || echo "")

      if [ -z "$API_ENDPOINT" ]; then
        echo "âŒ Could not get API endpoint. Run 'task tofu-apply' first."
        exit 1
      fi

      echo "âœ… API Endpoint: $API_ENDPOINT"
      echo ""
      echo "Update MindBodyDictionaryMobile/NotificationConfig.cs:"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
      echo "public const string BackendServiceEndpoint = \"$API_ENDPOINT\";"
      echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  run-android:
    desc: Clean and run Android app (Debug)
    dir: MindBodyDictionaryMobile
    cmds:
    - task: build-debug
    - dotnet build -f net10.0-android -c Debug -t:run

  build-debug:
    desc: Clean and build iOS and Android (Debug)
    cmds:
    - task: clean
    - dotnet build -c Debug

  setup-complete:
    desc: Complete end-to-end setup
    cmds:
    - echo "ğŸš€ Starting complete push notifications setup..."
    - echo ""
    - task: check-prereqs
    - task: firebase-setup
    - task: apple-info
    - task: generate-api-key
    - task: create-tfvars
    - echo ""
    - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
    - echo "âœ… Automated setup complete!"
    - echo ""
    - echo "Next manual steps{{":"}}
    - echo "1. Complete Apple Developer Portal setup (see output above)"
    - echo "2. Edit tofu/terraform.tfvars with all credentials"
    - echo "3. Run{{":"}} task tofu-apply"
    - echo "4. Run{{":"}} task update-notification-config"
    - echo "5. Deploy backend API to Azure App Service"
    - echo "6. Run{{":"}} task build"
    - echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

  clean:
    desc: Clean build artifacts (dotnet clean + rm)
    silent: true
    cmds:
    - dotnet clean MindBodyDictionaryMobile/MindBodyDictionaryMobile.csproj || true
    - rm -rf MindBodyDictionaryMobile/bin MindBodyDictionaryMobile/obj
    - rm -rf tofu/.terraform tofu/.terraform.lock.hcl
    - echo "âœ… Cleaned build artifacts"

  install-xcode:
    desc: Install Xcode 26.0 using .xip download
    cmds:
    - |
      echo "Checking for Xcode .xip file..."
      if [ -f {{.XCODE_XIP_FILENAME}} ]; then
        echo "Existing .xip file found, skipping download."
      fi
      if [ ! -f {{.XCODE_XIP_FILENAME}} ]; then
        if [ "{{.XCODE_XIP_URL}}" = "REPLACE_WITH_ACTUAL_URL_FROM_DEVELOPER_APPLE_COM" ]; then
          echo "Error: XCODE_XIP_URL must be set before first use. This is a one-time setup for Xcode 26.0.1. Please update Taskfile.yml with the download URL from https://developer.apple.com/download/all/?q=Xcode"
          echo "Alternatively, download {{.XCODE_XIP_FILENAME}} (Xcode 26.0.1) manually and place it in the current directory, then run this task again."
          exit 1
        fi
        curl -fS -O {{.XCODE_XIP_URL}}
        if [ ! -f {{.XCODE_XIP_FILENAME}} ] || [ ! -s {{.XCODE_XIP_FILENAME}} ]; then
          echo "Download failed or file is empty."
          exit 1
        fi
        echo "Download complete. File size: $(ls -lh {{.XCODE_XIP_FILENAME}} | awk '{print $5}')"
      fi
      if [ -f {{.XCODE_XIP_FILENAME}} ]; then
        if [ -d Xcode.app ]; then
          echo "Xcode.app already extracted, skipping extraction."
        else
          echo "Extracting Xcode..."
          echo "This may take 30+ minutes for large Xcode archives. Please wait..."
          xip -x {{.XCODE_XIP_FILENAME}}
        fi
        echo "Moving Xcode to Applications..."
        echo "Moving Xcode to Applications..."
        if [ -d /Applications/Xcode_{{.XCODE_VERSION}}.app ]; then
          echo "Removing existing /Applications/Xcode_{{.XCODE_VERSION}}.app..."
          sudo rm -rf /Applications/Xcode_{{.XCODE_VERSION}}.app
        fi
        sudo mv Xcode.app /Applications/Xcode_{{.XCODE_VERSION}}.app
        echo "Setting Xcode {{.XCODE_VERSION}} as the active developer directory..."
        sudo xcode-select -s /Applications/Xcode_{{.XCODE_VERSION}}.app/Contents/Developer
        echo "Verifying installation..."
        xcodebuild -version
        echo "No Xcode .xip file available. Installation aborted."
        exit 1
      fi

  run-ios:
    desc: Run the iOS app on iPhone 17 Pro simulator
    cmds:
    - dotnet build -f net10.0-ios -c debug -t:run -p:_DeviceName=:v2:udid=A4A1F78D-4814-4500-A2F3-928F35CF37BC
