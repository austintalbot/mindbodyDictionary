version: '3'

includes:
  backend: ./backend/Taskfile.yml

vars:
  PROJECT_NAME: mindbody-dictionary
  ANDROID_PACKAGE: com.mindbodydictionary.mindbodydictionarymobile
  IOS_BUNDLE_ID: com.mindbodydictionary.mindbodydictionarymobile
  FIREBASE_PROJECT_ID: '{{.FIREBASE_PROJECT_ID | default "mindbody-dictionary"}}'
  APPLE_TEAM_ID: '{{.APPLE_TEAM_ID}}'
  APNS_KEY_NAME: MindBodyDictionaryAPNsKey
  XCODE_VERSION: '26.0.1'
  XCODE_XIP_URL: 'REPLACE_WITH_ACTUAL_URL_FROM_DEVELOPER_APPLE_COM'
  XCODE_XIP_FILENAME: 'Xcode_{{.XCODE_VERSION}}_Apple_silicon.xip'

dotenv: [ '.env' ]

tasks:
  default:
    desc: Show available tasks
    cmds:
    - task --list

  check-prereqs:
    desc: Check if required CLIs are installed
    cmds:
    - |
      echo "Checking prerequisites..."
      command -v firebase >/dev/null 2>&1 || { echo "‚ùå Firebase CLI not installed. Run: npm install -g firebase-tools"; exit 1; }
      echo "‚úÖ Firebase CLI found"
      command -v gcloud >/dev/null 2>&1 || { echo "‚ö†Ô∏è  Google Cloud CLI not found (optional but recommended)"; }
      echo "Note: Apple Developer tasks require manual portal access (no official CLI)"
      echo "‚úÖ Prerequisites check complete"

  firebase-login:
    desc: Login to Firebase
    cmds:
    - firebase login
    status:
    - firebase projects:list >/dev/null 2>&1

  firebase-create-project:
    desc: Create Firebase project
    deps: [ firebase-login ]
    cmds:
    - |
      echo "Creating Firebase project: {{.FIREBASE_PROJECT_ID}}"
      firebase projects:create {{.FIREBASE_PROJECT_ID}} --display-name "{{.PROJECT_NAME}}"
    status:
    - firebase projects:list | grep -q {{.FIREBASE_PROJECT_ID}}

  firebase-add-android:
    desc: Add Android app to Firebase project
    deps: [ firebase-create-project ]
    cmds:
    - |
      echo "Adding Android app to Firebase project..."
      firebase apps:create ANDROID \
        --project={{.FIREBASE_PROJECT_ID}} \
        --package-name={{.ANDROID_PACKAGE}}
    status:
    - firebase apps:list ANDROID --project={{.FIREBASE_PROJECT_ID}} 2>&1 | grep -q "ANDROID"
    preconditions:
    - sh: firebase projects:list | grep -q {{.FIREBASE_PROJECT_ID}}
      msg: "Firebase project {{.FIREBASE_PROJECT_ID}} does not exist. Run 'task firebase-create-project' first."

  firebase-download-config:
    desc: Download google-services.json
    deps: [ firebase-add-android ]
    cmds:
    - |
      echo "Downloading google-services.json..."
      firebase apps:sdkconfig ANDROID \
        --project={{.FIREBASE_PROJECT_ID}} \
        --out=MindBodyDictionaryMobile/Platforms/Android/google-services.json 
      echo "‚úÖ google-services.json downloaded to MindBodyDictionaryMobile/Platforms/Android/"

  firebase-enable-fcm:
    desc: Enable Firebase Cloud Messaging (requires gcloud)
    deps: [ firebase-create-project ]
    cmds:
    - |
      echo "Enabling Firebase Cloud Messaging API..."
      gcloud services enable fcm.googleapis.com --project={{.FIREBASE_PROJECT_ID}}
      echo "‚úÖ FCM enabled"
    preconditions:
    - sh: command -v gcloud >/dev/null 2>&1
      msg: "Google Cloud CLI not found. Install from: https://cloud.google.com/sdk/docs/install"

  firebase-get-server-key:
    desc: Get FCM credentials (requires manual steps)
    cmds:
    - |
      echo "üìã To get your FCM credentials:"
      echo "1. Go to: https://console.firebase.google.com/project/{{.FIREBASE_PROJECT_ID}}/settings/cloudmessaging"
      echo "2. Under 'Firebase Cloud Messaging API (V1)' - verify it shows 'Enabled'"
      echo "3. Note your Sender ID (e.g., 533561443811)"
      echo "4. Click 'Manage Service Accounts' to open Google Cloud Console"
      echo "5. Create/download a service account key (JSON format)"
      echo "6. Add to tofu/terraform.tfvars:"
      echo "   - fcm_sender_id = \"YOUR_SENDER_ID\""
      echo "   - fcm_service_account_key = content of service account JSON file"
      echo ""
      echo "Note: The legacy Server Key API was deprecated 6/20/2023 and removed 6/20/2024."
      echo "Firebase now uses the V1 API with service account authentication."
      echo ""
      echo "Opening Firebase Console..."
      open "https://console.firebase.google.com/project/{{.FIREBASE_PROJECT_ID}}/settings/cloudmessaging" || true

  firebase-setup:
    desc: Complete Firebase setup (create project, add Android app, download config)
    cmds:
    - task: check-prereqs
    - task: firebase-create-project
    - task: firebase-add-android
    - task: firebase-download-config
    - task: firebase-get-server-key

  apple-info:
    desc: Display Apple Developer setup instructions
    cmds:
    - |
      echo "üçé Apple Push Notification Setup"
      echo "=================================="
      echo ""
      echo "Apple does not provide a CLI for Developer Portal management."
      echo "You must complete these steps manually:"
      echo ""
      echo "1. CREATE APP IDENTIFIER"
      echo "   ‚Ä¢ Go to: https://developer.apple.com/account/resources/identifiers/list"
      echo "   ‚Ä¢ Click '+' to create new identifier"
      echo "   ‚Ä¢ Select 'App IDs' ‚Üí Continue"
      echo "   ‚Ä¢ Select 'App' ‚Üí Continue"
      echo "   ‚Ä¢ Description: MindBody Dictionary Mobile"
      echo "   ‚Ä¢ Bundle ID: {{.IOS_BUNDLE_ID}}"
      echo "   ‚Ä¢ Enable 'Push Notifications' capability"
      echo "   ‚Ä¢ Click Continue ‚Üí Register"
      echo ""
      echo "2. CREATE APNs AUTHENTICATION KEY"
      echo "   ‚Ä¢ Go to: https://developer.apple.com/account/resources/authkeys/list"
      echo "   ‚Ä¢ Click '+' to create new key"
      echo "   ‚Ä¢ Key Name: {{.APNS_KEY_NAME}}"
      echo "   ‚Ä¢ Enable 'Apple Push Notifications service (APNs)'"
      echo "   ‚Ä¢ Click Continue ‚Üí Register"
      echo "   ‚Ä¢ Download the .p8 file (you can only download once!)"
      echo "   ‚Ä¢ Note the Key ID (10 characters)"
      echo "   ‚Ä¢ Note your Team ID (top-right corner of portal)"
      echo ""
      echo "3. SAVE CREDENTIALS"
      echo "   ‚Ä¢ Move .p8 file to a secure location"
      echo "   ‚Ä¢ Update tofu/terraform.tfvars:"
      echo "     - apns_bundle_id = \"{{.IOS_BUNDLE_ID}}\""
      echo "     - apns_key_id = \"YOUR_KEY_ID\""
      echo "     - apns_team_id = \"YOUR_TEAM_ID\""
      echo "     - apns_token = content of .p8 file (including BEGIN/END lines)"
      echo ""
      echo "Opening Apple Developer Portal..."
      open "https://developer.apple.com/account/resources/identifiers/list" || true

  generate-api-key:
    desc: Generate secure API key for terraform.tfvars
    cmds:
    - |
      echo "Generating secure API key..."
      API_KEY=$(openssl rand -base64 32)
      echo ""
      echo "‚úÖ Generated API Key:"
      echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      echo "$API_KEY"
      echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
      echo ""
      echo "Add this to tofu/terraform.tfvars:"
      echo "api_key = \"$API_KEY\""
      echo ""
      echo "And to MindBodyDictionaryMobile/NotificationConfig.cs:"
      echo "public const string ApiKey = \"$API_KEY\";"

  create-tfvars:
    desc: Create terraform.tfvars from example
    dir: tofu
    cmds:
    - |
      if [ -f terraform.tfvars ]; then
        echo "‚ö†Ô∏è  terraform.tfvars already exists"
        read -p "Overwrite? (y/N): " confirm
        if [ "$confirm" != "y" ] && [ "$confirm" != "Y" ]; then
          echo "Cancelled"
          exit 0
        fi
      fi
      cp terraform.tfvars.example terraform.tfvars
      echo "‚úÖ Created tofu/terraform.tfvars from example"
      echo "‚ö†Ô∏è  Please edit this file and fill in all values"
      echo ""
      echo "Run these tasks to help:"
      echo "  task generate-api-key    # Generate API key"
      echo "  task firebase-setup      # Setup Firebase"
      echo "  task apple-info          # Apple setup instructions"

  tofu-init:
    desc: Initialize OpenTofu
    dir: tofu
    cmds:
    - tofu init
    sources:
    - "*.tf"
    status:
    - test -d .terraform

  tofu-plan:
    desc: Plan OpenTofu deployment
    dir: tofu
    deps: [ tofu-init ]
    cmds:
    - tofu plan
    preconditions:
    - sh: test -f terraform.tfvars
      msg: "terraform.tfvars not found. Run 'task create-tfvars' first."

  tofu-apply:
    desc: Apply OpenTofu deployment
    dir: tofu
    deps: [ tofu-init ]
    cmds:
    - tofu apply
    preconditions:
    - sh: test -f terraform.tfvars
      msg: "terraform.tfvars not found. Run 'task create-tfvars' first."

  tofu-destroy:
    desc: Destroy OpenTofu infrastructure
    dir: tofu
    cmds:
    - tofu destroy
    preconditions:
    - sh: test -f terraform.tfvars
      msg: "terraform.tfvars not found."

  tofu-output:
    desc: Show OpenTofu outputs
    dir: tofu
    cmds:
    - tofu output

  apns-configure:
    desc: Configure APNS for iOS notifications (Sandbox or Production)
    dir: tofu
    cmds:
    - ./configure-apns.sh {{ .APNS_MODE | default "Sandbox" }}
    preconditions:
    - sh: test -f configure-apns.sh
      msg: "configure-apns.sh not found"
    - sh: test -f ../AuthKey_5R75Q6ALPT_dev.p8
      msg: "APNS dev key file not found"

  notifications-setup:
    desc: Complete notifications setup (Terraform + APNS)
    cmds:
    - echo "üì± Setting up Azure Notification Hub..."
    - task: tofu-init
    - task: tofu-apply
    - echo ""
    - echo "üçé Configuring APNS for iOS..."
    - task: apns-configure
    - echo ""
    - echo "‚úÖ Notifications setup complete!"

  update-notification-config:
    desc: Update NotificationConfig.cs with Tofu outputs
    dir: tofu
    cmds:
    - |
      echo "Extracting Tofu outputs..."
      API_ENDPOINT=$(tofu output -raw api_endpoint 2>/dev/null || echo "")

      if [ -z "$API_ENDPOINT" ]; then
        echo "‚ùå Could not get API endpoint. Run 'task tofu-apply' first."
        exit 1
      fi

      echo "‚úÖ API Endpoint: $API_ENDPOINT"
      echo ""

  send-notification:
    desc: Send test push notification to iOS and Android
    cmds:
    - ./send-notification.sh

  send-notification-ios:
    desc: Send test notification to iOS only
    cmds:
    - ./send-notification.sh "Hello iOS" "Test for iOS"

  send-notification-android:
    desc: Send test notification to Android only
    cmds:
    - ./send-notification.sh "Hello Android" "Test for Android" echo "Update MindBodyDictionaryMobile/NotificationConfig.cs:" echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ" echo "public const string BackendServiceEndpoint = \"$API_ENDPOINT\";" echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

  run-android:
    desc: Clean and run Android app (Debug)
    dir: MindBodyDictionaryMobile
    cmds:
    - task: build-debug
    - dotnet build -f net10.0-android -c Debug -t:run

  build-debug:
    desc: Clean and build iOS and Android (Debug)
    cmds:
    - task: clean
    - dotnet build -c Debug

  setup-complete:
    desc: Complete end-to-end setup
    cmds:
    - echo "üöÄ Starting complete push notifications setup..."
    - echo ""
    - task: check-prereqs
    - task: firebase-setup
    - task: apple-info
    - task: generate-api-key
    - task: create-tfvars
    - echo ""
    - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"
    - echo "‚úÖ Automated setup complete!"
    - echo ""
    - echo "Next manual steps{{":"}}
    - echo "1. Complete Apple Developer Portal setup (see output above)"
    - echo "2. Edit tofu/terraform.tfvars with all credentials"
    - echo "3. Run{{":"}} task tofu-apply"
    - echo "4. Run{{":"}} task update-notification-config"
    - echo "5. Deploy backend API to Azure App Service"
    - echo "6. Run{{":"}} task build"
    - echo "‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ"

  clean:
    desc: Clean build artifacts (dotnet clean + rm)
    silent: true
    cmds:
    - dotnet clean MindBodyDictionaryMobile/MindBodyDictionaryMobile.csproj || true
    - rm -rf MindBodyDictionaryMobile/bin MindBodyDictionaryMobile/obj
    - rm -rf tofu/.terraform tofu/.terraform.lock.hcl
    - echo "‚úÖ Cleaned build artifacts"

  install-xcode:
    desc: Install Xcode 26.0 using .xip download
    cmds:
    - |
      echo "Checking for Xcode .xip file..."
      if [ -f {{.XCODE_XIP_FILENAME}} ]; then
        echo "Existing .xip file found, skipping download."
      fi
      if [ ! -f {{.XCODE_XIP_FILENAME}} ]; then
        if [ "{{.XCODE_XIP_URL}}" = "REPLACE_WITH_ACTUAL_URL_FROM_DEVELOPER_APPLE_COM" ]; then
          echo "Error: XCODE_XIP_URL must be set before first use. This is a one-time setup for Xcode 26.0.1. Please update Taskfile.yml with the download URL from https://developer.apple.com/download/all/?q=Xcode"
          echo "Alternatively, download {{.XCODE_XIP_FILENAME}} (Xcode 26.0.1) manually and place it in the current directory, then run this task again."
          exit 1
        fi
        curl -fS -O {{.XCODE_XIP_URL}}
        if [ ! -f {{.XCODE_XIP_FILENAME}} ] || [ ! -s {{.XCODE_XIP_FILENAME}} ]; then
          echo "Download failed or file is empty."
          exit 1
        fi
        echo "Download complete. File size: $(ls -lh {{.XCODE_XIP_FILENAME}} | awk '{print $5}')"
      fi
      if [ -f {{.XCODE_XIP_FILENAME}} ]; then
        if [ -d Xcode.app ]; then
          echo "Xcode.app already extracted, skipping extraction."
        else
          echo "Extracting Xcode..."
          echo "This may take 30+ minutes for large Xcode archives. Please wait..."
          xip -x {{.XCODE_XIP_FILENAME}}
        fi
        echo "Moving Xcode to Applications..."
        echo "Moving Xcode to Applications..."
        if [ -d /Applications/Xcode_{{.XCODE_VERSION}}.app ]; then
          echo "Removing existing /Applications/Xcode_{{.XCODE_VERSION}}.app..."
          sudo rm -rf /Applications/Xcode_{{.XCODE_VERSION}}.app
        fi
        sudo mv Xcode.app /Applications/Xcode_{{.XCODE_VERSION}}.app
        echo "Setting Xcode {{.XCODE_VERSION}} as the active developer directory..."
        sudo xcode-select -s /Applications/Xcode_{{.XCODE_VERSION}}.app/Contents/Developer
        echo "Verifying installation..."
        xcodebuild -version
        echo "No Xcode .xip file available. Installation aborted."
        exit 1
      fi

  run-ios:
    desc: Run the iOS app on iPhone 17 Pro simulator
    cmds:
    - dotnet build -f net10.0-ios -c debug -t:run -p:_DeviceName=:v2:udid=A4A1F78D-4814-4500-A2F3-928F35CF37BC

  test:notifications:
    desc: Test push notifications on Android and iOS
    cmds:
    - echo "Testing Android notification..."
    - ./send-test-notification.sh
    - echo ""
    - echo "iOS notifications require physical device and valid APNS setup"
    - echo "Check Azure Portal for notification delivery status"

  functions:check:
    desc: Verify Azure Functions prerequisites
    cmds:
    - |
      echo "Checking Azure Functions prerequisites..."
      command -v az >/dev/null 2>&1 || { echo "‚ùå Azure CLI not installed. Run: https://learn.microsoft.com/en-us/cli/azure/install-azure-cli"; exit 1; }
      echo "‚úÖ Azure CLI found"
      command -v tofu >/dev/null 2>&1 || { echo "‚ùå OpenTofu not installed. Run: https://opentofu.org/docs/intro/install/"; exit 1; }
      echo "‚úÖ OpenTofu found"
      command -v dotnet >/dev/null 2>&1 || { echo "‚ùå .NET SDK not installed"; exit 1; }
      echo "‚úÖ .NET SDK found"
      echo "‚úÖ Prerequisites check complete"

  functions:validate:
    desc: Validate Azure Functions configuration
    dir: tofu
    cmds:
    - |
      if [ ! -f terraform.tfvars.staging ]; then
        echo "‚ùå terraform.tfvars.staging not found"
        exit 1
      fi
      echo "‚úÖ Configuration file found"
    - tofu validate -var-file=terraform.tfvars.staging
    - echo "‚úÖ Configuration is valid"

  functions:init:
    desc: Initialize OpenTofu for Azure Functions
    dir: tofu
    deps: [ functions:check ]
    cmds:
    - tofu init -var-file=terraform.tfvars.staging
    status:
    - test -d .terraform

  functions:plan:
    desc: Plan Azure Functions infrastructure deployment
    dir: tofu
    deps: [ functions:init ]
    cmds:
    - tofu plan -var-file=terraform.tfvars.staging -out=tfplan
    preconditions:
    - sh: test -f terraform.tfvars.staging
      msg: "terraform.tfvars.staging not found"

  functions:apply:
    desc: Apply Azure Functions infrastructure deployment
    dir: tofu
    deps: [ functions:init ]
    cmds:
    - |
      if [ -f tfplan ]; then
        tofu apply tfplan
        rm -f tfplan
      else
        tofu apply -var-file=terraform.tfvars.staging
      fi
    - echo "‚úÖ Infrastructure deployed"
    - tofu output -json > outputs.json
    - echo "üìã Outputs saved to tofu/outputs.json"
    preconditions:
    - sh: test -f terraform.tfvars.staging
      msg: "terraform.tfvars.staging not found"

  functions:deploy-infra:
    desc: Plan and deploy Azure Functions infrastructure (staging slot)
    cmds:
    - task: functions:check
    - task: functions:init
    - task: functions:validate
    - task: functions:plan
    - |
      echo ""
      echo "üìã Infrastructure plan ready for staging slot deployment"
      read -p "Continue? (y/n) " -r
      if [[ $REPLY =~ ^[Yy]$ ]]; then
        task functions:apply
      else
        echo "Deployment cancelled"
      fi

  functions:build:
    desc: Build .NET 10 Azure Functions project
    dir: backend/src/MindBodyDictionary.AdminApi
    cmds:
    - dotnet clean
    - dotnet build -c Release
    - echo "‚úÖ Build complete"

  functions:publish:
    desc: Publish Azure Functions to Azure
    cmds:
    - |
      echo "üì¶ Publishing Azure Functions..."
      cd backend/src/MindBodyDictionary.AdminApi
      rm -rf publish
      dotnet publish -c Release -o publish
      echo "‚úÖ Published to ./publish"

      echo ""
      echo "üöÄ Deploying to Azure..."
      APP_NAME=$(cd ../../../tofu && tofu output -raw function_app_name 2>/dev/null)

      if [ -z "$APP_NAME" ]; then
        echo "‚ùå Function app not deployed. Run 'task functions:deploy-infra' first"
        exit 1
      fi

      if command -v func >/dev/null 2>&1; then
        func azure functionapp publish "$APP_NAME" --build remote
      else
        echo "‚ö†Ô∏è  Using Azure CLI (Azure Functions Core Tools not found)"
        cd publish
        zip -r ../MindBodyDictionary.AdminApi.zip . > /dev/null 2>&1
        cd ..
        az functionapp deployment source config-zip \
          --resource-group mbd-backend-rg \
          --name "$APP_NAME" \
          --src-path MindBodyDictionary.AdminApi.zip
        rm -f MindBodyDictionary.AdminApi.zip
      fi

      echo "‚úÖ Functions deployed successfully to $APP_NAME"

  functions:info:
    desc: Display deployed staging slot information
    dir: tofu
    cmds:
    - |
      echo "üìä Staging Slot Deployment Information"
      echo "========================================"
      echo ""
      
      SLOT_HOSTNAME=$(tofu output -raw staging_slot_hostname 2>/dev/null || echo "")
      if [ -z "$SLOT_HOSTNAME" ]; then
        echo "‚ùå Staging slot not deployed"
        exit 1
      fi
      
      echo "‚úÖ Function App: mbd-mobile-api"
      echo "   Staging Slot: staging"
      echo "   URL: https://$SLOT_HOSTNAME"
      echo "   Storage: mbdstoragesa"
      echo ""
      echo "üìç Portal: https://portal.azure.com/#resource/subscriptions/49fbd6b5-f722-420c-a6b1-961f1b03813c/resourceGroups/mbd-backend-rg/providers/Microsoft.Web/sites/mbd-admin-api/slots/staging"
      echo ""
      echo "üí° Deployment commands:"
      echo "   Swap to production: az functionapp deployment slot swap --name mbd-admin-api --resource-group mbd-backend-rg --slot staging"

  functions:list:
    desc: List deployed Azure Functions
    dir: tofu
    cmds:
    - |
      APP_NAME=$(tofu output -raw function_app_name 2>/dev/null || echo "")
      if [ -z "$APP_NAME" ]; then
        echo "‚ùå Function app not deployed"
        exit 1
      fi

      az functionapp function list \
        --resource-group mbd-backend-rg \
        --name "$APP_NAME" \
        --query "[].{Name: name, Trigger: trigger.type}" -o table

  functions:logs:
    desc: View Azure Functions deployment logs
    dir: tofu
    cmds:
    - |
      APP_NAME=$(tofu output -raw function_app_name 2>/dev/null || echo "")
      if [ -z "$APP_NAME" ]; then
        echo "‚ùå Function app not deployed"
        exit 1
      fi

      echo "üìã Latest deployment logs for $APP_NAME:"
      echo "=========================================="
      az functionapp log deployment show \
        --resource-group mbd-backend-rg \
        --name "$APP_NAME" \
        --slot staging 2>/dev/null || az functionapp log deployment show \
        --resource-group mbd-backend-rg \
        --name "$APP_NAME"

  functions:restart:
    desc: Restart Azure Functions app
    dir: tofu
    cmds:
    - |
      APP_NAME=$(tofu output -raw function_app_name 2>/dev/null || echo "")
      if [ -z "$APP_NAME" ]; then
        echo "‚ùå Function app not deployed"
        exit 1
      fi

      az functionapp restart \
        --resource-group mbd-backend-rg \
        --name "$APP_NAME"

      echo "‚úÖ Function app restarted"

  functions:outputs:
    desc: Display all Tofu outputs
    dir: tofu
    cmds:
    - tofu output

  functions:destroy:
    desc: Destroy Azure Functions infrastructure
    dir: tofu
    cmds:
    - |
      echo "‚ö†Ô∏è  This will DELETE all Azure Functions infrastructure!"
      read -p "Type 'yes' to confirm: " -r
      if [[ $REPLY == "yes" ]]; then
        tofu destroy
        echo "‚úÖ Infrastructure destroyed"
      else
        echo "Cancelled"
      fi

  functions:full-setup:
    desc: Complete end-to-end Azure Functions setup (infra + functions)
    cmds:
    - echo "üöÄ Starting complete Azure Functions setup..."
    - echo ""
    - task: functions:deploy-infra
    - echo ""
    - task: functions:build
    - echo ""
    - task: functions:publish
    - echo ""
    - task: functions:info
    - echo ""
    - echo "‚úÖ Azure Functions setup complete!"

  functions:help:
    desc: Show Azure Functions task documentation
    cmds:
    - |
      echo "üìò Azure Functions with .NET 10 - OpenTofu"
      echo "============================================="
      echo ""
      echo "Resource Groups:"
      echo "  task functions:create-resource-group  # Create functions resource group"
      echo "  task functions:show-resource-groups   # Show all resource groups"
      echo ""
      echo "Quick Start:"
      echo "  task functions:check            # Verify prerequisites"
      echo "  task functions:deploy-infra     # Deploy Azure infrastructure"
      echo "  task functions:build            # Build .NET functions"
      echo "  task functions:publish          # Deploy functions to Azure"
      echo ""
      echo "Monitoring:"
      echo "  task functions:info             # Show deployment info"
      echo "  task functions:list             # List deployed functions"
      echo "  task functions:logs             # Stream live logs"
      echo "  task functions:restart          # Restart function app"
      echo ""
      echo "Configuration:"
      echo "  Edit tofu/terraform.tfvars before deploying"
      echo "  See tofu/AZURE_FUNCTIONS_DOTNET10.md for detailed docs"
      echo ""
      echo "Full Deployment:"
      echo "  task functions:full-setup       # One-command setup"
      echo ""
      echo "Cleanup:"
      echo "  task functions:destroy          # Delete all infrastructure"

  functions:create-resource-group:
    desc: Create separate resource group for serverless functions
    dir: tofu
    cmds:
    - |
      echo "üì¶ Creating resource group for serverless functions..."
      echo ""

      RG_NAME=$(tofu output -raw functions_resource_group_name 2>/dev/null || echo "rg-mindbody-functions")
      LOCATION=$(tofu output -raw location 2>/dev/null || echo "eastus" | grep -oE '[^/]+$')

      # Check if resource group already exists
      if az group show --name "$RG_NAME" --subscription 49fbd6b5-f722-420c-a6b1-961f1b03813c &>/dev/null; then
        echo "‚úÖ Resource group '$RG_NAME' already exists"
      else
        echo "Creating new resource group: $RG_NAME in $LOCATION"
        az group create \
          --name "$RG_NAME" \
          --location "$LOCATION" \
          --subscription 49fbd6b5-f722-420c-a6b1-961f1b03813c \
          --tags Component=Serverless Purpose="Azure Functions and related resources"
        
        if [ $? -eq 0 ]; then
          echo "‚úÖ Resource group created successfully"
        else
          echo "‚ùå Failed to create resource group"
          exit 1
        fi
      fi

      echo ""
      echo "Resource Group Details:"
      az group show \
        --name "$RG_NAME" \
        --subscription 49fbd6b5-f722-420c-a6b1-961f1b03813c \
        --query "{Name: name, Location: location, Id: id}" -o table

  functions:show-resource-groups:
    desc: Show both notification and functions resource groups
    cmds:
    - |
      echo "üìä MindBody Dictionary Resource Groups"
      echo "======================================"
      echo ""

      az group list \
        --subscription 49fbd6b5-f722-420c-a6b1-961f1b03813c \
        --query "[?contains(name, 'mindbody')].{Name: name, Location: location}" \
        -o table

      echo ""
      echo "Detailed Status:"
      echo ""

      # Notifications RG
      echo "üîî Notifications Resource Group"
      if az group show --name "rg-mindbody-notifications" --subscription 49fbd6b5-f722-420c-a6b1-961f1b03813c &>/dev/null; then
        echo "   ‚úÖ Status: Exists"
        az group show \
          --name "rg-mindbody-notifications" \
          --subscription 49fbd6b5-f722-420c-a6b1-961f1b03813c \
          --query "{Name: name, Location: location}" -o table
      else
        echo "   ‚ùå Status: Not found"
      fi

      echo ""

      # Functions RG
      echo "‚ö° Functions Resource Group"
      if az group show --name "rg-mindbody-functions" --subscription 49fbd6b5-f722-420c-a6b1-961f1b03813c &>/dev/null; then
        echo "   ‚úÖ Status: Exists"
        az group show \
          --name "rg-mindbody-functions" \
          --subscription 49fbd6b5-f722-420c-a6b1-961f1b03813c \
          --query "{Name: name, Location: location}" -o table
        
        echo ""
        echo "üìã Resources in Functions RG:"
        az resource list \
          --resource-group "rg-mindbody-functions" \
          --subscription 49fbd6b5-f722-420c-a6b1-961f1b03813c \
          --query "[].{Name: name, Type: type}" -o table
      else
        echo "   ‚ùå Status: Not created yet"
        echo "   Run: task functions:create-resource-group"
      fi
